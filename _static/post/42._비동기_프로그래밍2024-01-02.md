---
template : "post"
title : "42. 비동기 프로그래밍"
category : ""
tags : "DeepDive"
created: "2024-01-02"
---

# 42. 비동기 프로그래밍

- 자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택을 갖는다.
- 실행 중인 실행 컨텍스트를 제외한 모든 실행 컨텍스트는 모두 실행 대기 중인 태스크들이다.
- 자바스크립트 엔진은 한 번에 하나의 태스크만 실행할 수 있는 싱글 스레드 방식을 동작한다.
- 처리에 시간이 걸리는 태스크를 실행하는 경우 블로킹(작업 중단)이 발생한다.
- 현재 실행 중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대기하는 것을 동기 처리라고 한다.
- setTimeout 함수처럼 블로킹하지 않고 이후 태스크를 곧바로 실행시키는 것을 비동기 처리라고 한다.
- 동기 처리 방식은 순서를 보장하지만 비동기 처리 방식은 순서를 보장하지 않는다.
- 비동기 처리 방식은 전통적으로 콜백 패턴을 사용한다.

## 이벤트 루프와 태스크 큐

- 자바스크립트의 동시성을 지원하는 것이 이벤트 루프다.
- 자바스크립트는 크게 콜 스택과 힙의 영역으로 구분할 수 있다.

> 💡 **콜 스택**  
> 소스코드 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조인 실행 컨텍스트 스택이 콜 스택이다.


> 💡 **힙**  
> 객체가 저장되는 메모리 공간이다. 실행 컨텍스트는 힙에 저장된 객체를 참조한다.  
> 객체는 원시 값과 달리 크기가 정해져 있지 않으므로 할당해야할 메모리 공간의 크기를 런타임에 결정(동적 할당)해야 한다.  
> 객체가 저장되는 메모리 공간인 힙은 구조화 되어 있지 않다.

- 브라우저 또는 Node.js 환경에서 태스크 큐와 이벤트 루프를 제공한다.
- 자바스크립트는 싱글 스레드로 동작하지만 브라우저는 멀티 스레드로 동작한다.

> 💡 **태스크 큐(task queue/event queue/callback queue)**  
> 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역이다.


> 💡 **이벤트 루프**  
> 콜 스택에 현재 실행 중인 실행 컨텍스트가 있는지, 태스크 큐에 대기 중인 함수가 있는지 반복해서 확인한다.  
> 콜 스택이 비어있고 태스크 큐에 대기 중인 함수가 있다면 이벤트 루프는 순차적으로 태스크 큐에 대기 중인 함수를 콜 스택으로 이동시킨다.  
> 이때 콜 스택으로 이동한 함수는 실행된다.

- 비동기 함수의 콜백 함수는 태스크 큐에 푸쉬되어 대기하다가 콜 스택이 비게 되면,
- 이벤트 루프에 의해 태스크 큐에 대기 중인 함수를 콜 스택에 푸시되어 실행한다.
- 즉, 전역 코드 및 명시적으로 호출된 함수가 모두 종료되어야 한다.
- 콜 스택이 비어야 호출되므로 스케줄링한 콜백 함수는 정확히 지연 시간 후에 호출된다는 보장은 없다.
- 콜백 함수를 태스크 큐에 등록하는 처리는 브라우저가 실행한다.
- 브라우저와 자바스크립트 엔진이 협력하여 비동기 함수를 실행한다.

```javascript
function sleep(fuc, delay) {
    const delayUntil = Date.now() + delay;
    while (Date.now() < delayUntil);
    fuc();
}

/* 비동기 : 3초 뒤에 콘솔 출력 */
setTimeout(
		// 3초후에 이벤트 루프에 의해 태스크 큐에 푸시되어 대기한다.
    function () { console.log('time out end') },
    3000
)

/* 동기 : 10초 뒤에 콘솔 출력 */
sleep(
    function () { console.log('sleep end') },
    1000
)


/*
	3초뒤에 'time out end'이 콘솔 출력되고 10초뒤에 'sleep end'이 콘솔에 출력되야 하지만
	10초뒤에 'sleep end'출력되고 'time out end'이 출력된다.
	이벤트 루프가 콜 스택이 비어있어야 테스크 큐에 있는 함수를 콜 스택으로 이동시키기 때문이다.
	
	sleep end
	time out end
*/
```

