---
template : "post"
title : "24. 클로저"
category : ""
tags : "DeepDive"
created: "2023-12-22"
---

# 24. 클로저

- 클로저는 자바스크립트 고유의 개념이 아니다.
- 클로저는 함수와 그 함수가 선언된 렉시컬 환경의 조합이다.

## 렉시컬 스코프

- 함수의 정의한 위치에  의해 상위 스코프가 정적으로 결정되고 변하지 않는 것을 말한다.
- 렉시컬 스코프는 실행 컨텍스트 `렉시컬 환경의 외부 렉시컬 환경에 대한 참조`이다.
- 실행 컨텍스트 렉시컬 환경의 외부 렉시컬 환경을 통해 상위 렉시컬 환경과 연결한다.
- 상위 렉시컬 환경과 연결하는 것을 스코프 체인이라고 말한다.

## 함수 객체의 내부 슬롯 [[Environment]]

- 함수의 내부 슬롯 `[[Environment]]`은 상위 스코프의 참조(실행 컨텍스트의 렉시컬 환경)를 저장한다.
- `[[Environment]]` 에 저장된 상위 스코프의 참조는 현재 실행중인 컨텍스트의 렉시컬 환경을 가리킨다.
- 즉, 함수 정의가 평가되어 함수 객체를 생성하는 시점이다.
- `렉시컬 환경의 외부 렉시컬 환경에 대한 참조` 에는 함수의 내부 슬롯 `[[Environment]]` 에 저장된 렉시컬 환경의 참조가 할당된다.

## 클로저와 렉시컬 환경


```javascript
function outer() {
	const x = 10;
	return function() {
		console.log(x);
	}
}

const innerFnc = outer();
innerFnc(); // 10;
```

- outer 함수의 실행이 종료하면서 익명 함수 객체를 반환한다.
- outer  함수의 실행 컨텍스트가 실행 컨텍스트 스택에서 제거된다.
- 하지만 outer 함수의 렉시컬 환경은 익명 함수의 내부 슬롯 `[[Environment]]` 에 의해 참조되고 있다.
- 익명 함수는 전역 변수 innerFnc에 의해 참조되고 있으므로 가비지 컬렉터 대상이 아니다.
- 상위 스코프의 어떤 식별자도 참조하지 않는 경우 브라우저의 최적화를 통해 메모리 공간에서 제거된다.
- 클로저는 중첨 함수가 상위 스코프의 식별자를 참조하고 있고,
- 중첩 함수가 외부 함수보다 더 오래 유지되는 경우에 한정하는 것이 일반적이다.
- 클로저에 의해 참조되는 상위 스코프의 변수를 자유 변수라고 부른다.

## 캡슐화와 정보 은닉

- 캡슐화란 프로퍼티와 메서드를 하나로 묶는 것을 말한다.
- 정보 은닉은 캡슐화를 통해 특정 프로퍼티나 메서드를 감추는 것을 말한다.

자바스크립트는 `pulibc`, `private` , `protected` 같은 접근 제한자를 제공하지 않는다.


```javascript
const Person = (function() {
	let _age = 0;
	function Person(name, age) {
		this.name = name;
		_age = age;
	}

	Person.prototype.sayHello = function() {
		console.log(`Hi My name is ${this.name}, I am ${_age}`);
	}

	return Person; // 생성자 함수를 반환
}());
// 즉시 실행 함수를 통해 Person 생성자 함수를 반환한다.
// Person 변수에는 Person 생성자 함수 객체를 참조하고 있다.

const me = new Person('Lee', 20);
const you = new Person('Kim', 30);

me.sayHello(); // Hi My name is Lee, I am 30
you.sayHello(); // Hi My name is Kim, I am 30
```

- sayHi 메서드는 즉시 실행 함수의 실행 컨텍스트의 렉시컬 환경을 `[[Environment]]` 에 저장한다.
- sayHi 메서드의 상위 스코프는 동일한 상위 스코프를 사용하게 되어 변수의 상태가 유지되지 않는다.
- `private` 을 흉내 낼 수 는 있지만 사실상 불가능하다.
- 최신 브라우저와 Node.js(버전 12이상)부터는 가능하다.

## 자주 발생하는 실수


```javascript
var arr = [];
for(var i = 0; i < 3; i++) {
	arr.push(function() { return i });
}

for(var j = 0; j < arr.length; j++) {
	console.log(arr[j]());
}

// print : 3 3 3
```

- `var` 키워드로 선언한 변수는 함수 레벨 스코프를 갖기 때문에 전역 변수다.
- 해결 방법으로는 클로저를 사용하거나 `let` 키워드로 선언한 변수를 사용하는 것이다.
- `let` 키워드로 선언한 변수는 코드 블록 스코프를 갖기 때문에 독립적인 렉시컬 환경을 생성하여 식별자 값을 유지한다.
